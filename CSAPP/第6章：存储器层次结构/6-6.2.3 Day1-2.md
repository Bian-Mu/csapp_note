### 存储器系统
之前的简单模型：“存储器是一个线性的字节数组，cpu在常数时间内访问每个存储器位置”

实际上：
1. 具有不同容量、成本和访问时间的存储设备的多层次结构
2. cpu中保存着最常用的数据。
3. 靠近CPU的小型快速的**cache memory**充当缓冲区，用于存储相对较慢的**main memory**中的部分数据和指令。
4. **main memory**则作为大型慢速磁盘上数据的缓冲区，而这些磁盘又通常作为通过网络连接的其他机器上磁盘或磁带存储数据的缓冲区。

> 分层次的可行性：
> 	 大部分程序只频繁访问一个层的存储设备，或者是附近层（局部性）；
> 	 可以达成最底层成本很低但由于多层结构，最终向顶层传输时速率差别不大
> 	 
> ![[cc29685641ad3163e84c37acb58feca8.png]]

### 存储技术

#### 随机访问存储器（RAM）
##### SRAM(static)
- 将每个位都存储在一个双稳态的存储器单元里。该单元的电路可以无期限的保持在两个不同的电压状态之一，如果变成不稳定状态则会立刻变动。
![[7bc2c5f148412b6d5b7229bf688c454b.png]]
##### DRAM(dynamic)
- 每个位存储成一个电容的充电（该电容非常小），由一个晶体管访问。由于对干扰非常敏感（所以是dynamic），当电容电压被扰乱后就不会恢复了。
- 很多原因会导致漏电，但时钟周期比漏电速率小很多
- 内存系统会周期性的读出，并通过重写来刷新内存的每一位；部分系统会给每个字增加纠错码来校验
![[e369ab244cb6b1765b7faa18d5171574.png]]

##### 传统的DRAM
![[c2657a5edb60968ea40248263ed1be66.png]]![[231f8a6229ddb84051ebe07ca540f3c2.png]]
![[ef20564d7b7f58d55f6d6b71cdc07f8c.png]]

##### 内存模块
DRAM芯片封装在内存模块里，插在主板的扩展槽上
![[60047352ace93e2053d3cdf8e164b655.png]]![[e4c6b795c0a1a1d8d1935a3dddfcc39c.png]]

##### 增强的DRAM
1. 快页模式（FPM DRAM）：允许对同一行连续访问，可以直接从行缓冲区得到多个超单元
2. 扩展数据输出（EDO DRAM）：比上一个在CAS信号的时间上更紧密
3. 同步（SDRAM）：常规的DRAM与内存控制器通信时使用一组显示的控制信号，而SDRAM用与驱动内存控制器相同的外部时钟信号来代替大部分控制信号，达成同步
4. 双倍速率（DDR DRAM）：使用两个时钟作为控制信号
5. 视频（VRAM）：用在图形系统的帧缓冲区中，输出由对内部缓冲区整个内容的移位得到，且允许并行的读写内存。所以可以在下一次更新的时候用帧缓冲区的像素刷新屏幕

##### 非易失性存储器
- 如果断电，SRAM和DRAM会丢失信息，是易失的。
**只读存储器ROM实际上有些类型可以读也可以写**，以其能被重编程（写）的次数和重编程（写）所用机制来分类的。

1. PROM：只能被编程一次，每个存储器单元有一种高电流熔断丝
2. 可擦写可编程（EPROM）：紫外线光照射时，单元清除为0,需要特殊工具编程，电子化的EEPROM需要用印制电路上编程
3. 闪存（flash memory）：基于EEPROM，大量使用，例如固态硬盘（SSD）

存储在ROM中的程序称为固件。当计算机通电时，会运行ROM中的固件。
- 一些固件中有少量输入输出函数，如PC的BIOS（基本输入输出系统）例程
- 复杂设备，如磁盘驱动控制器，也以来固件翻译CPU的IO请求

##### 访问主存
数据流通过总线（bus）这一共享电子电路在处理器和DRAM主存之间来回。每次数据传送通过的一系列步骤称为总线事务，分为：
- 读事务：从主存到CPU
- 写事务：从CPU到主存
![[9a5478663edddb2fb47cee9502741233.png]]

1. 读事务的流程：
![[08ada8f8a27557615bd49424ef5da0a4.png]]
2. 写事务的流程：
![[4d92a5228436a6acfa9a47229145337a.png]]

#### 磁盘存储
##### 磁盘构造
![[1460324147cc2ce0aa2aca2f9542c315.png]]
- 磁盘由多个盘片叠放而成，每个盘片都有两面（表面），绕主轴旋转，每个表面是一组称为磁道的同心圆。
- 每个磁道被划分为一组扇区，其中包含等量的数据位（通常是512字节）。
- 数据位编码在扇区上的磁性材料中，扇区之间有间隙隔开，间隙存储用来标识扇区的格式化位。
- 上图整个装置被称为磁盘驱动器

##### 磁盘容量
可以记录的最大位数

受到以下因素影响：
1. 记录密度：单位英寸可以容纳的位数
2. 磁道密度：从圆心出发每英寸的磁道数
3. 面密度：上述二者乘积

##### 磁盘操作
磁盘用读/写头来读写存储在磁性表面的位，头一端连接到传动臂，传动臂可以旋转。
驱动器可以借助传动臂读写任何磁道，每个盘片都有读写头，同轴转动。
![[24f71b8ffc1cbe793abe346ee4ab542c.png]]
磁盘以扇区大小的块来读写，访问时间分为三个部分：
1. 寻道时间：传动臂定位
2. 旋转时间：定位后，驱动器等待目标扇区的第一个位旋转到读写头下方
3. 传送时间：到下方后，读写

- 访问扇区中第一个字节比较费时

##### 逻辑磁盘块
为了隐藏操作的复杂性，将一个B个扇区大小的逻辑块从0开始编号到B-1。封装中有一个磁盘控制器，用于维护逻辑号码与物理地址的映射关系

当OS要执行I/O操作时，OS会发送一个指令到磁盘控制器，它翻译成（盘面、磁道、扇区）的三元组，随后读写头移动，等待扇区转动而来，随后读写的位被放入控制器的缓冲区，等待被复制到主存中

##### 连接I/O设备
![[53819a70174400fc8b080e4afd0ff65c.png]]
比系统总线和内存总线要慢，但可以容纳种类繁多的第三方设备
1. 通用串行总线（USB）
	USB3.0带宽为625mb/s 3.1为1250mb/s
2. 图形卡（适配器）
3. 主机总线适配器
	1. 将一个/多个磁盘连接到I/O总线，使用特别的主机总线接口定义的通信协议。		
	2. 常用协议有SCSI和SATA（前者比后者快且可以支持多个磁盘驱动器）
4. 网络适配器（网卡）

##### 访问磁盘
![[87f5366b9a95b5d732a8880905eba28d.png]]

- CPU使用内存映射I/O的技术向I/O设备发送命令，在使用该映射的系统中，地址空间中有一块地址是为与I/O设备通信保留的，称为I/O端口。
- 每个设备连接到总线时，会与一个或者多个端口相关联

![[36ad2b0a80ad907ff3cbf9b10dac9d2a.png]]![[d549106818db481c58c107cacae330f8.png]]


#### 固态硬盘（SSD）
基于闪存的存储技术，封装插到I/O总线上的USB/SATA槽上，处理来自CPU的读写请求。

- 一个SSD封装由一个或多个闪存芯片和闪存翻译层构成，闪存芯片代替机械驱动器、闪存翻译层代替磁盘控制器，转换逻辑地址
![[f4fa699ab91e35f3528904199d9fe88a.png]]
- 读SSD比写要快，数据以页为读写单位，只有在页所属的块整个被擦掉后才能写。不过，一旦整个被擦，块中每一页都不需要再进行擦除就可以写一次。块会在使用一定程度后损坏
- 写的慢的原因：
	1. 擦块需要较长的时间，比访问页要高一个数量级
	2. 如果要写一个已经有被写过的块，则要先把原块中被写过的页复制到新块中，然后才能写

SSD特点：
1. 半导体构成，不需要移动，访问快、能耗低、结实
2. 更容易磨损，但翻译层中的平均磨损逻辑会将磨损分给每个块而最大化寿命

##### 性能差距
![[74149ac92829914854b218dd2ac78925.png]]
### 局部性
倾向于使用最近引用过的数据项或者它们的临近项

1. 时间局部性：被引用过的内存位置会在不远的将来多次被引用
2. 空间局部性：被引用过的内存的附近的位置会在不远的将来被引用

#### 程序数据引用的局部性
![[05dfb2a02213288d3a5289edcab75cfa.png]]
sum：时间局部性
v[i]：空间局部性，引用时步长越小空间局部性越好

#### 取指令的局部性
- 例如来回调用不同的函数会降低空间局部性（因为指令存放在不同的内存位置）；
- 循环有良好的局部性，循环体越小、迭代次数越多，局部性越好

