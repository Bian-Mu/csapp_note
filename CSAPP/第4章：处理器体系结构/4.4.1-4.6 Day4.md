### 计算流水线
![[c63ddc25f91d396699064e256bdbe1e4.png]]
I1,I2,I3是操作名

![[70aa4ec1bf085cbda64dc93234eaf84d.png]]
GIPS：每秒千兆条指令（10^9）
1. 吞吐量：在流水线中，吞吐量是指单位时间内能完成的指令数。理想状态下，一旦流水线被充分填满，每个时钟周期可能就会有一个指令完成，这意味着最大吞吐量是每个时钟周期一个指令。
2. 延迟：从开始执行第一个指令到该指令完成所有阶段所需的时间


**流水线**
![[38c4acc7d03998c4cfaae9c3a853e43f.png]]
1. 将每个操作I的计算分成ABC三个阶段，每个阶段结束后进入流水线寄存器，故全部完成需要**3个时钟周期**，当I1从A阶段进入B阶段时，I2操作就可以进入A阶段了。在稳定状态下，三个阶段ABC都是活动的
2. 时钟周期为(100+20)ps，**时钟周期是流水线中最慢阶段所需的最小时间间隔。它直接影响到流水线的吞吐量：时钟周期越短，单位时间内可能执行的周期数就越多，理论上吞吐量也就越高。** 

### 详细说明

![[dd96f67c26085ea3bdf497d47a3d82a2.png]]
> 流水线阶段之间的指令转移是由时钟信号控制的，每次进入新的周期，信号从0上升到1

![[1fe16f847dbdb1ee75bf69d3c7acdb45.png]]Phase：
1. AB中的值已经到达寄存器的输入，但寄存器状态和输出还未改变
2. 输入被加载到寄存器中，成为寄存器而输出，同时阶段A的输入被设置成**启动I3的计算**
3. 信号传播通过每个阶段的组合逻辑，波阵面表示信号传播的速率可能不同
4. 结果值到达下一个寄存器

> 减缓时钟不会影响流水线行为（流水线的基本逻辑和阶段的功能，在时钟速度变化时保持不变，仍然并行各个阶段）
> 信号传播到寄存器的输入，但时钟上升时才改变寄存器
> 如果时钟周期太短，可能会导致值还没有到达寄存器的输入时，时钟就已经上升了


### 局限性
1. 不同组合逻辑所需要的时间可能不一样，此时周期T由最慢的阶段决定
2. 部分硬件单元，例如ALU和内存，是不能被划分成小延迟单元的
3. 时钟周期缩短，但由于大量寄存器的延迟，导致最终的性能（吞吐量）提升不显著![[e15dd97bc8306ddaee1df0239ade4481.png]]
		T缩短了2倍，而性能为原先的：14.29/8.33=1.71倍，寄存器延迟在此处站了28.6%


### 流水线系统的反馈
考虑到部分指令之间是相互关联的，而非汽车加工的各个部件
1. 数值的使用
2. 程序寄存器的使用
3. 指令控制（分支语句等）
![[2c30cc13b8511973c20d7b6f0769c8a5.png]]
直接不加以调整的在流水线中引入反馈，可能会导致I4的A的输入为I1的C的输出


### 数据冲突：
当一个指令所需数据还未由前一条指令计算完成时，可能导致暂停
1. 写后读（RAW）：后续指令需要读取的数据还未被前面的指令写入。
2. 读后写（WAR）：一条指令尝试读取一个寄存器，而下一条指令需要写入同一个寄存器。
3. 写后写（WAW）：两条指令顺序写入同一个寄存器，但执行的顺序可能导致结果不确定。

### 解决数据冲突的策略
1. 流水线暂停：插入气泡（nop指令）覆盖某些指令的状态，同时使得某些指令暂停（保持当前状态不变），**让需要数据的指令停留在译码阶段**
2. 数据转发：在硬件中增加一些额外的数据连接与控制逻辑，在不同的操作间直接实现**在x的执行阶段将数据传送给y的译码阶段**传递数据，避免等待数据写回寄存器，例如将R1的值直接在执行阶段传给I2
```
	I1: ADD R1, R2, R3   // R1 = R2 + R3
	I2: SUB R4, R1, R5   // R4 = R1 - R5
```
3. 暂停与转发结合：可以实现**在x的访存阶段转发给y的译码阶段**
4. 避免控制冒险：
	- **分支预测**：通过预测分支跳转是否发生以及跳转的目的地，可以提前取指，减少因等待分支决定而造成的暂停。
	- **延迟分支**：将一些无关的指令放在分支指令后面执行，这样即使分支的决策尚未完成，处理器也可以继续执行这些无关指令，从而提高效率。
	- **分支目标缓冲**（BTB）：存储历史分支的目标地址，当相同的分支指令再次执行时，可以直接从缓冲中获取跳转地址。
	- **ret指令**：流水线暂停，直到ret指令写回
	- **指令排除**：预测错误时，对于正在运行的错误指令，**在它们的译码阶段和执行阶段插入气泡来取消，并拿出之后应该要跳转的代码**

### 异常处理
1. 多个异常出现时，优先**报告最深处指令的异常**（即写回>访存>执行>译码>取指）
2. 执行一条指令出现了异常，而后该指令由于分支预测错误取消了执行，则会**直接取消异常状态的记录**
3. 流水线化的处理器会在不同的阶段更新系统状态的不同部分，如果出现这种情况：x导致了异常，但y指令在x完成前改变了系统状态；**当处于访存或写回阶段的指令导致异常时，流水线控制会禁止接下来的条件码寄存器和数据内存的更新**（因为我们可以保证第一个遇到异常的指令是第一个被写回的）

### 性能分析
见p322

### 未讨论的问题
1. 多周期指令，例如浮点数加法，整数除法
2. 与存储系统的接口，实际读写时要翻译成物理地址。访问的内存不在RAM中时（例如磁盘），会导致缺页异常；高速缓存，提供常用存储器位置的快速访问；翻译后备缓冲器，提供的对虚拟地址到物理地址的快速翻译


## 注意
有关SEQ与SEQ+，以及部分PIPE，鉴于实用性以及难度，选择放弃